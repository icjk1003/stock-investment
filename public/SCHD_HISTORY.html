<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SCHD ê³¼ê±° ëˆ„ì ë§¤ìˆ˜ ë°±í…ŒìŠ¤íŠ¸ | í†µí•© ìì‚° ì‹œë®¬ë ˆì´í„°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
    body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
    .month-row { display: none; }
    .month-row.active { display: table-row; }
  </style>
</head>

<body class="p-4 md:p-8">
<div class="max-w-6xl mx-auto">

  <div class="flex justify-end mb-4">
    <a href="SCHD.html" class="text-sm font-bold text-gray-500 hover:text-blue-600 transition">â† SCHD ë¯¸ë˜ ì‹œë®¬ë ˆì´í„°</a>
  </div>

  <header class="mb-8 text-center">
    <h1 class="text-3xl font-bold text-blue-700">SCHD ê³¼ê±° ëˆ„ì ë§¤ìˆ˜ ë°±í…ŒìŠ¤íŠ¸ ğŸ“ˆ</h1>
    <p class="text-gray-600 mt-2">ê³¼ê±° ì‹œì‘ì¼ë¶€í„° ë§¤ì›”/ë§¤ì¼ ë§¤ìˆ˜í–ˆì„ ë•Œ, ì‹¤ì œ ê°€ê²©/ë°°ë‹¹ + ë‹¹ì‹œ í™˜ìœ¨(USD/KRW)ì„ ë°˜ì˜í•´ ê³„ì‚°í•©ë‹ˆë‹¤</p>
    <p id="dataNotice" class="text-xs text-gray-400 mt-2"></p>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
    <!-- Left: Inputs -->
    <div class="lg:col-span-1">
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
        <h2 class="text-xl font-semibold border-b pb-2 text-gray-800">íˆ¬ì ì„¤ì • (KRW)</h2>

        <div>
          <label class="block text-xs font-medium text-gray-500">í‹°ì»¤</label>
          <input type="text" id="ticker" value="SCHD"
                 class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
          <p class="text-[11px] text-gray-400 mt-1">ê¸°ë³¸: SCHD</p>
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-500">ì‹œì‘ì¼</label>
          <input type="date" id="startDate"
                 class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
          <p class="text-[11px] text-gray-400 mt-1">
            ì„ íƒí•œ ë‚ ì§œê°€ ë°ì´í„° ì‹œì‘ë³´ë‹¤ ì´ë¥´ë©´ ìë™ìœ¼ë¡œ ê°€ëŠ¥í•œ ë‚ ì§œë¶€í„° ê³„ì‚°ë©ë‹ˆë‹¤.
          </p>
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-500">ë§¤ìˆ˜ ì£¼ê¸°</label>
          <select id="freq" class="w-full mt-1 p-2 border rounded-md outline-blue-500">
            <option value="monthly" selected>ë§¤ì›” (í•´ë‹¹ ì›” ì²« ê±°ë˜ì¼)</option>
            <option value="daily">ë§¤ì¼ (ê±°ë˜ì¼ ê¸°ì¤€)</option>
          </select>
          <p class="text-[11px] text-gray-400 mt-1">
            * ë§¤ì¼ì€ â€œê±°ë˜ì¼ë§ˆë‹¤ buy ê¸ˆì•¡â€ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤(ì˜ë„ì™€ ë‹¤ë¥´ë©´ ë§í•´ì¤˜. ì›”ê¸ˆì•¡ì„ ì¼í• ë¡œ ë°”ê¾¸ëŠ” ê²ƒë„ ê°€ëŠ¥).
          </p>
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-500">ë§¤ìˆ˜ ê¸ˆì•¡ (ì›, KRW)</label>
          <input type="number" id="buyKRW" value="2000000"
                 class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-500">ë°°ë‹¹ì„¸ìœ¨ (%)</label>
          <input type="number" id="tax" value="15" step="0.1"
                 class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
        </div>

        <div class="flex items-center gap-2">
          <input type="checkbox" id="drip" checked class="h-4 w-4"/>
          <label for="drip" class="text-sm text-gray-700 font-semibold">ë°°ë‹¹ ì¬íˆ¬ì(DRIP)</label>
        </div>

        <button onclick="runBacktest()"
                class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">
          ê³„ì‚°í•˜ê¸°
        </button>

        <p class="text-[11px] text-gray-400 leading-relaxed">
          * ê°€ê²©/ë°°ë‹¹/í™˜ìœ¨ ë°ì´í„°ëŠ” ì„œë²„(Firebase Functions)ì—ì„œ ì¡°íšŒí•©ë‹ˆë‹¤.<br/>
          * í™˜ìœ¨ì€ USD/KRW(1ë‹¬ëŸ¬ë‹¹ ì›í™”) ê¸°ì¤€ì´ë©°, ë§¤ìˆ˜/ë°°ë‹¹ ë‚ ì§œ í™˜ìœ¨ë¡œ KRWâ†”USD ë³€í™˜ë©ë‹ˆë‹¤.
        </p>
      </div>
    </div>

    <!-- Right: Chart + summary -->
    <div class="lg:col-span-3 space-y-6">
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
        <div style="position: relative; height:450px; width:100%">
          <canvas id="unifiedChart"></canvas>
        </div>
      </div>

      <!-- Summary cards: ì›ë³¸ ê³„ì‚°ê¸°ì²˜ëŸ¼ 3ê°œ -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
        <div class="bg-slate-900 p-5 rounded-2xl text-white shadow-lg">
          <p class="text-slate-400 text-xs uppercase">ìµœì¢… ìì‚°</p>
          <p id="resTotal" class="text-xl font-bold mt-1">-</p>
        </div>
        <div class="bg-emerald-600 p-5 rounded-2xl text-white shadow-lg">
          <p class="text-emerald-100 text-xs uppercase">ëˆ„ì  ìˆ˜ìµ</p>
          <p id="resProfit" class="text-xl font-bold mt-1">-</p>
        </div>
        <div class="bg-amber-500 p-5 rounded-2xl text-white shadow-lg">
          <p class="text-amber-50 text-xs uppercase">ìµœì¢… ì›” ë°°ë‹¹</p>
          <p id="resMonthlyDiv" class="text-xl font-bold mt-1">-</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="mt-8 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 overflow-x-auto">
    <h2 class="text-xl font-semibold mb-4 border-b pb-2">ì—°ë„ë³„ ìƒì„¸ ë°ì´í„°</h2>
    <table class="w-full text-left text-sm border-collapse">
      <thead>
      <tr class="bg-gray-100 text-gray-600 border-b text-xs uppercase">
        <th class="p-3">ì—°ì°¨/ì›”</th>
        <th class="p-3">ëˆ„ì  ì›ê¸ˆ</th>
        <th class="p-3 text-emerald-600">ëˆ„ì  ì‹œì„¸ì°¨ìµ</th>
        <th class="p-3 text-amber-600">ëˆ„ì  ë°°ë‹¹ìˆ˜ìµ</th>
        <th class="p-3 font-bold text-slate-900">ì´ í‰ê°€ìì‚°</th>
        <th class="p-3">ì›” ë°°ë‹¹ê¸ˆ(ì„¸í›„)</th>
      </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <footer class="mt-16 py-8 text-center text-xs text-gray-400 border-t">
    Â© 2026 SCHD Asset Simulator Â· Contact: icjk1003@gmail.com
  </footer>
</div>

<script>
  let unifiedChart;

  function ymd(d){ return new Date(d).toISOString().slice(0,10); }
  function monthKey(dateStr){ return dateStr.slice(0,7); }
  function fmtKRW(v){ return Math.round(v).toLocaleString() + "ì›"; }
  function toNum(x){ const n = Number(x); return Number.isFinite(n) ? n : 0; }

  function toggleMonths(key) {
    document.querySelectorAll(`.month-${key}`).forEach(r => r.classList.toggle('active'));
  }

  async function fetchHistory(ticker, start, end) {
    const url = `/api/schdHistory?ticker=${encodeURIComponent(ticker)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error("ê°€ê²©/ë°°ë‹¹ ì¡°íšŒ ì‹¤íŒ¨: " + (await r.text()));
    return r.json();
  }

  async function fetchFx(start, end) {
    const url = `/api/fxHistory?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error("í™˜ìœ¨ ì¡°íšŒ ì‹¤íŒ¨: " + (await r.text()));
    return r.json();
  }

  function buildContributionSet(prices, freq, startDateStr) {
    const set = new Set();
    if (freq === "daily") {
      for (const p of prices) set.add(p.date);
      return set;
    }
    let lastMonth = null;
    for (const p of prices) {
      const mk = monthKey(p.date);
      if (mk !== lastMonth) {
        lastMonth = mk;
        if (p.date >= startDateStr) set.add(p.date);
      }
    }
    return set;
  }

  // fxMap(date->rate)ê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë‹ˆ "í•´ë‹¹ì¼ ìˆìœ¼ë©´ ê·¸ê±¸, ì—†ìœ¼ë©´ ì§ì „ê°’" ì‚¬ìš©
  function makeFxGetter(fxPricesSorted) {
    const map = new Map();
    for (const p of fxPricesSorted) map.set(p.date, p.close);

    // dateë“¤ì´ ì •ë ¬ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
    let last = null;
    const dates = fxPricesSorted.map(x => x.date);

    return function getFx(dateStr) {
      if (map.has(dateStr)) { last = map.get(dateStr); return last; }
      // ì§ì „ê°’ ì°¾ê¸°(ì„ í˜•ìœ¼ë¡œ í•˜ë©´ ëŠë¦¬ë‹ˆê¹Œ ì´ì§„íƒìƒ‰)
      let lo = 0, hi = dates.length - 1, ans = -1;
      while (lo <= hi) {
        const mid = (lo + hi) >> 1;
        if (dates[mid] <= dateStr) { ans = mid; lo = mid + 1; }
        else hi = mid - 1;
      }
      if (ans >= 0) { last = fxPricesSorted[ans].close; return last; }
      // ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ìœ¼ë¡œ ê¸°ì–µí•œ ê°’, ê·¸ê²ƒë„ ì—†ìœ¼ë©´ 0
      return last || 0;
    };
  }

  function updateChart(labels, p, g, d, t) {
    const ctx = document.getElementById('unifiedChart').getContext('2d');
    if (unifiedChart) unifiedChart.destroy();

    unifiedChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'ì›ê¸ˆ', data: p, stack: 'a', fill: true, pointRadius: 0 },
          { label: 'ì‹œì„¸ì°¨ìµ', data: g, stack: 'a', fill: true, pointRadius: 0 },
          { label: 'ë°°ë‹¹ìˆ˜ìµ', data: d, stack: 'a', fill: true, pointRadius: 0 },
          { label: 'ì´ìì‚°', data: t, borderWidth: 2, fill: false, pointRadius: 0 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            stacked: true,
            ticks: { callback: v => Math.round(v / 100000000) + "ì–µ" }
          }
        }
      }
    });
  }

  async function runBacktest() {
    try {
      const ticker = (document.getElementById('ticker').value.trim() || "SCHD");
      const startInput = document.getElementById('startDate').value;
      if (!startInput) { alert("ì‹œì‘ì¼ì„ ì„ íƒí•´ì¤˜!"); return; }

      const freq = document.getElementById('freq').value;
      const buyKRW = Math.max(0, toNum(document.getElementById('buyKRW').value));
      const taxRate = Math.max(0, toNum(document.getElementById('tax').value) / 100);
      const drip = document.getElementById('drip').checked;

      const end = ymd(new Date());

      // 1) ê°€ê²©/ë°°ë‹¹ + í™˜ìœ¨ ë¡œë“œ (ë³‘ë ¬)
      const [data, fx] = await Promise.all([
        fetchHistory(ticker, startInput, end),
        fetchFx(startInput, end)
      ]);

      const pricesAll = data.prices || [];
      const divsAll = data.dividends || [];
      const fxAll = fx.prices || [];

      if (pricesAll.length < 10) { alert("ê°€ê²© ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ìš”. í‹°ì»¤/ê¸°ê°„ í™•ì¸!"); return; }
      if (fxAll.length < 10) { alert("í™˜ìœ¨ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ìš”. ì ì‹œ í›„ ë‹¤ì‹œ!"); return; }

      // ì‹¤ì œ ê°€ëŠ¥í•œ ì‹œì‘ì¼
      const firstAvail = data.firstDate || pricesAll[0].date;
      const startDate = (startInput < firstAvail) ? firstAvail : startInput;

      document.getElementById("dataNotice").innerText =
        `ê°€ê²©ë°ì´í„°: ${data.firstDate || "-"} ~ ${data.lastDate || "-"} / í™˜ìœ¨ë°ì´í„°: ${fx.firstDate || "-"} ~ ${fx.lastDate || "-"} / ê³„ì‚° ì‹œì‘: ${startDate}`;

      // 2) ì‹œì‘ì¼ ì´í›„ ê°€ê²©ë§Œ
      const prices = pricesAll.filter(p => p.date >= startDate);
      if (prices.length < 10) { alert("ì‹œì‘ì¼ ì´í›„ ë°ì´í„°ê°€ ë„ˆë¬´ ì§§ì•„ìš”."); return; }

      // 3) ë°°ë‹¹ ë§µ (date -> perShare)
      const divMap = new Map();
      for (const d of divsAll) {
        if (!d?.date) continue;
        const amt = toNum(d.amount);
        if (amt <= 0) continue;
        divMap.set(d.date, (divMap.get(d.date) || 0) + amt);
      }

      // 4) fx getter (USD/KRW)
      fxAll.sort((a,b)=>a.date.localeCompare(b.date));
      const getFx = makeFxGetter(fxAll);

      // 5) ë§¤ìˆ˜ì¼ ê²°ì •
      const contributeSet = buildContributionSet(prices, freq, startDate);

      // 6) ì‹œë®¬ë ˆì´ì…˜
      let shares = 0;
      let principalKRW = 0;  // ëˆ„ì  ì›ê¸ˆ(ì›í™”) - ì‚¬ìš©ìê°€ ì‹¤ì œë¡œ ë‚©ì…í•œ ê¸ˆì•¡
      let divNetKRW = 0;     // ëˆ„ì  ë°°ë‹¹ìˆ˜ìµ(ì„¸í›„, ì›í™” í™˜ì‚°)
      let cashUSD = 0;       // DRIP OFF ë°°ë‹¹ í˜„ê¸ˆ(USD)

      // ì›” ìŠ¤ëƒ…ìƒ·
      const months = [];
      let currentMonth = null;
      let monthDivNetKRW = 0;

      for (let i = 0; i < prices.length; i++) {
        const { date, close } = prices[i];
        const mk = monthKey(date);

        if (currentMonth === null) currentMonth = mk;

        // ì›” ë°”ë€ŒëŠ” ì‹œì ì— ì´ì „ ì›” ìŠ¤ëƒ…ìƒ· ì €ì¥
        if (mk !== currentMonth) {
          const prev = prices[i - 1];
          const fxEnd = getFx(prev.date) || 0;

          const valueUSD = shares * prev.close + cashUSD;
          const valueKRW = valueUSD * fxEnd;

          const capGainKRW = valueKRW - principalKRW - divNetKRW;

          months.push({
            key: currentMonth,
            endDate: prev.date,
            principalKRW,
            capGainKRW,
            divNetKRW,
            valueKRW,
            monthDivNetKRW,
          });

          currentMonth = mk;
          monthDivNetKRW = 0;
        }

        // (A) ë§¤ìˆ˜ (í•´ë‹¹ì¼ í™˜ìœ¨ë¡œ KRW->USD)
        if (contributeSet.has(date) && buyKRW > 0) {
          const fxRate = getFx(date);
          if (fxRate > 0) {
            const buyUSD = buyKRW / fxRate;
            shares += (buyUSD / close);
            principalKRW += buyKRW;
          }
        }

        // (B) ë°°ë‹¹ ì´ë²¤íŠ¸: ì£¼ë‹¹ë°°ë‹¹(perShare) * ì£¼ì‹ìˆ˜
        const perShare = divMap.get(date) || 0;
        if (perShare > 0) {
          const grossUSD = shares * perShare;
          const netUSD = grossUSD * (1 - taxRate);

          // ë°°ë‹¹ì€ "ì§€ê¸‰ì¼ í™˜ìœ¨"ë¡œ KRW í™˜ì‚°í•´ì„œ ëˆ„ì 
          const fxRate = getFx(date);
          const netKRW = (fxRate > 0) ? netUSD * fxRate : 0;

          divNetKRW += netKRW;
          monthDivNetKRW += netKRW;

          if (drip) {
            // ë°°ë‹¹ ì¬íˆ¬ì: USDë¡œ ì£¼ì‹ ì¶”ê°€ë§¤ìˆ˜
            shares += (netUSD / close);
          } else {
            cashUSD += netUSD;
          }
        }
      }

      // ë§ˆì§€ë§‰ ì›” ìŠ¤ëƒ…ìƒ·
      const last = prices[prices.length - 1];
      const fxEnd = getFx(last.date) || 0;

      const valueUSD = shares * last.close + cashUSD;
      const valueKRW = valueUSD * fxEnd;
      const capGainKRW = valueKRW - principalKRW - divNetKRW;

      months.push({
        key: currentMonth,
        endDate: last.date,
        principalKRW,
        capGainKRW,
        divNetKRW,
        valueKRW,
        monthDivNetKRW,
      });

      // 7) ì—°ë„ë³„ë¡œ í‘œ êµ¬ì„±(ì—°ë„ í´ë¦­ -> ì›” í† ê¸€)
      const byYear = new Map();
      for (const m of months) {
        const y = m.key.slice(0,4);
        if (!byYear.has(y)) byYear.set(y, []);
        byYear.get(y).push(m);
      }
      const years = Array.from(byYear.keys()).sort();

      // 8) ì¹´ë“œ(ì›ë³¸ ê³„ì‚°ê¸°ì²˜ëŸ¼ 3ê°œ)
      const final = months[months.length - 1];
      document.getElementById("resTotal").innerText = fmtKRW(final.valueKRW);
      document.getElementById("resProfit").innerText = fmtKRW(final.valueKRW - final.principalKRW);

      // ìµœì¢… ì›” ë°°ë‹¹(ì„¸í›„): ë§ˆì§€ë§‰ ì›” monthDivNetKRW
      document.getElementById("resMonthlyDiv").innerText = fmtKRW(final.monthDivNetKRW);

      // 9) í…Œì´ë¸” + ì°¨íŠ¸ ë°ì´í„°
      const tableBody = document.getElementById("tableBody");
      tableBody.innerHTML = "";

      const labels = [];
      const pData = [];
      const gData = [];
      const dData = [];
      const tData = [];

      for (const y of years) {
        const list = byYear.get(y);

        // ì—°ë„ ë§ˆì§€ë§‰ ì›” ê¸°ì¤€ ëˆ„ì ê°’
        const yLast = list[list.length - 1];

        tableBody.innerHTML += `
          <tr class="year-header border-b hover:bg-blue-50 cursor-pointer" onclick="toggleMonths('y${y}')">
            <td class="p-3 font-bold text-blue-700">â–¶ ${y}ë…„</td>
            <td class="p-3">${fmtKRW(yLast.principalKRW)}</td>
            <td class="p-3 text-emerald-600 font-semibold">${fmtKRW(yLast.capGainKRW)}</td>
            <td class="p-3 text-amber-600 font-semibold">${fmtKRW(yLast.divNetKRW)}</td>
            <td class="p-3 font-black text-slate-900 bg-slate-50">${fmtKRW(yLast.valueKRW)}</td>
            <td class="p-3 font-bold text-gray-700">-</td>
          </tr>
        `;

        for (const mm of list) {
          tableBody.innerHTML += `
            <tr class="month-row month-y${y} bg-gray-50 border-b text-gray-400 text-xs">
              <td class="p-2 pl-8 font-medium text-blue-400">ã„´ ${mm.key}</td>
              <td class="p-2">${fmtKRW(mm.principalKRW)}</td>
              <td class="p-2">${fmtKRW(mm.capGainKRW)}</td>
              <td class="p-2">${fmtKRW(mm.divNetKRW)}</td>
              <td class="p-2 font-bold">${fmtKRW(mm.valueKRW)}</td>
              <td class="p-2 text-amber-500">${fmtKRW(mm.monthDivNetKRW)}</td>
            </tr>
          `;

          // ì°¨íŠ¸(ì›” ë‹¨ìœ„)
          labels.push(mm.key);
          pData.push(mm.principalKRW);
          gData.push(mm.capGainKRW);
          dData.push(mm.divNetKRW);
          tData.push(mm.valueKRW);
        }
      }

      updateChart(labels, pData, gData, dData, tData);

    } catch (e) {
      console.error(e);
      alert(String(e));
    }
  }

  // ê¸°ë³¸ ì‹œì‘ì¼
  document.getElementById("startDate").value = "2012-01-01";
</script>
</body>
</html>
