<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SCHD ê³¼ê±° ëˆ„ì ë§¤ìˆ˜ ë°±í…ŒìŠ¤íŠ¸ | í†µí•© ìì‚° ì‹œë®¬ë ˆì´í„°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
    body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
    .month-row { display: none; }
    .month-row.active { display: table-row; }
  </style>
</head>

<body class="p-4 md:p-8">
  <div class="max-w-6xl mx-auto">
    <header class="mb-8 text-center">
      <h1 class="text-3xl font-bold text-blue-700">SCHD ê³¼ê±° ëˆ„ì ë§¤ìˆ˜ ë°±í…ŒìŠ¤íŠ¸ ğŸ“ˆ</h1>
      <p class="text-gray-600 mt-2">ê³¼ê±° ì‹œì‘ì¼ë¶€í„° ë§¤ì›”/ë§¤ì¼ ë§¤ìˆ˜í–ˆì„ ë•Œ, ê°€ê²©/ë°°ë‹¹ì„ ë°˜ì˜í•œ ëˆ„ì  ì„±ê³¼ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤</p>
      <p id="dataNotice" class="text-xs text-gray-400 mt-2"></p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Left: Inputs -->
      <div class="lg:col-span-1">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
          <h2 class="text-xl font-semibold border-b pb-2 text-gray-800">íˆ¬ì ì„¤ì •</h2>

          <div>
            <label class="block text-xs font-medium text-gray-500">í‹°ì»¤</label>
            <input type="text" id="ticker" value="SCHD"
              class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
            <p class="text-[11px] text-gray-400 mt-1">ê¸°ë³¸: SCHD (ë¯¸êµ­ ETF)</p>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500">ì‹œì‘ì¼</label>
            <input type="date" id="startDate"
              class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
            <p class="text-[11px] text-gray-400 mt-1">ì„ íƒí•œ ë‚ ì§œê°€ ë°ì´í„° ì‹œì‘ë³´ë‹¤ ì´ë¥´ë©´ ìë™ìœ¼ë¡œ ê°€ëŠ¥í•œ ë‚ ì§œë¶€í„° ê³„ì‚°ë©ë‹ˆë‹¤.</p>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500">ë§¤ìˆ˜ ì£¼ê¸°</label>
            <select id="freq" class="w-full mt-1 p-2 border rounded-md outline-blue-500">
              <option value="monthly" selected>ë§¤ì›” (í•´ë‹¹ ì›” ì²« ê±°ë˜ì¼)</option>
              <option value="daily">ë§¤ì¼ (ê±°ë˜ì¼ ê¸°ì¤€)</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500">ë§¤ìˆ˜ ê¸ˆì•¡ (ì›, KRW)</label>
            <input type="number" id="buyKRW" value="2000000"
              class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500">í™˜ìœ¨ (KRW/USD)</label>
            <input type="number" id="fx" value="1350" step="1"
              class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
            <p class="text-[11px] text-gray-400 mt-1">ì›í™”ë¡œ ë„£ê³ , USDë¡œ í™˜ì‚°í•´ ë§¤ìˆ˜í•©ë‹ˆë‹¤.</p>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500">ë°°ë‹¹ì„¸ìœ¨ (%)</label>
            <input type="number" id="tax" value="15" step="0.1"
              class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
          </div>

          <div class="flex items-center gap-2">
            <input type="checkbox" id="drip" checked class="h-4 w-4"/>
            <label for="drip" class="text-sm text-gray-700 font-semibold">ë°°ë‹¹ ì¬íˆ¬ì(DRIP)</label>
          </div>

          <button onclick="runBacktest()"
            class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">
            ê³„ì‚°í•˜ê¸°
          </button>

          <p class="text-[11px] text-gray-400 leading-relaxed">
            * ê°€ê²©/ë°°ë‹¹ ë°ì´í„°ëŠ” ì„œë²„(Firebase Functions)ì—ì„œ ì¡°íšŒí•©ë‹ˆë‹¤. (ë¸Œë¼ìš°ì € CORS íšŒí”¼)<br/>
            * ë°°ë‹¹ ì´ë²¤íŠ¸ ë‚ ì§œëŠ” ë°ì´í„° ì œê³µì²˜ ê¸°ì¤€(ëŒ€ê°œ ë°°ë‹¹ ì´ë²¤íŠ¸ ë°œìƒì¼)ì…ë‹ˆë‹¤.
          </p>
        </div>
      </div>

      <!-- Right: Chart + summary -->
      <div class="lg:col-span-3 space-y-6">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <div style="position: relative; height:450px; width:100%">
            <canvas id="unifiedChart"></canvas>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
          <div class="bg-slate-900 p-5 rounded-2xl text-white shadow-lg">
            <p class="text-slate-400 text-xs uppercase">ìµœì¢… ìì‚°</p>
            <p id="resTotal" class="text-xl font-bold mt-1">-</p>
          </div>
          <div class="bg-emerald-600 p-5 rounded-2xl text-white shadow-lg">
            <p class="text-emerald-100 text-xs uppercase">ëˆ„ì  ìˆ˜ìµ</p>
            <p id="resProfit" class="text-xl font-bold mt-1">-</p>
          </div>
          <div class="bg-amber-500 p-5 rounded-2xl text-white shadow-lg">
            <p class="text-amber-50 text-xs uppercase">ëˆ„ì  ë°°ë‹¹(ì„¸í›„)</p>
            <p id="resDiv" class="text-xl font-bold mt-1">-</p>
          </div>
          <div class="bg-indigo-600 p-5 rounded-2xl text-white shadow-lg">
            <p class="text-indigo-100 text-xs uppercase">ë³´ìœ  ì£¼ì‹ìˆ˜</p>
            <p id="resShares" class="text-xl font-bold mt-1">-</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="mt-8 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 overflow-x-auto">
      <h2 class="text-xl font-semibold mb-4 border-b pb-2">ì—°ë„ë³„ ìƒì„¸ ë°ì´í„°</h2>
      <table class="w-full text-left text-sm border-collapse">
        <thead>
          <tr class="bg-gray-100 text-gray-600 border-b text-xs uppercase">
            <th class="p-3">ì—°/ì›”</th>
            <th class="p-3">ëˆ„ì  ì›ê¸ˆ</th>
            <th class="p-3 text-emerald-600">ê°€ê²© íš¨ê³¼</th>
            <th class="p-3 text-amber-600">ëˆ„ì  ë°°ë‹¹(ì„¸í›„)</th>
            <th class="p-3 font-bold text-slate-900">ì´ í‰ê°€ìì‚°</th>
            <th class="p-3">í•´ë‹¹ì›” ë°°ë‹¹(ì„¸í›„)</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <footer class="mt-16 py-8 text-center text-xs text-gray-400 border-t">
      Â© 2026 SCHD Asset Simulator Â· Contact: icjk1003@gmail.com
    </footer>
  </div>

<script>
  let unifiedChart;

  function ymd(d) {
    const x = new Date(d);
    return x.toISOString().slice(0,10);
  }

  function fmtKRW(v) {
    return Math.round(v).toLocaleString() + "ì›";
  }

  function toggleMonths(key) {
    document.querySelectorAll(`.month-${key}`).forEach(r => r.classList.toggle('active'));
  }

  // ì›” í‚¤: YYYY-MM
  function monthKey(dateStr) {
    return dateStr.slice(0,7);
  }

  async function fetchHistory(ticker, start, end) {
    // firebase.json rewrite ê¸°ì¤€
    const url = `/api/schdHistory?ticker=${encodeURIComponent(ticker)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error("ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: " + (await r.text()));
    return r.json();
  }

  function buildContributionSet(prices, freq, startDateStr) {
    // prices = [{date, close}] (ê±°ë˜ì¼ë§Œ)
    const isContribution = new Set();

    if (freq === "daily") {
      for (const p of prices) isContribution.add(p.date);
      return isContribution;
    }

    // monthly: ê° ì›”ì˜ ì²« ê±°ë˜ì¼ë§Œ
    let lastMonth = null;
    for (const p of prices) {
      const mk = monthKey(p.date);
      if (mk !== lastMonth) {
        lastMonth = mk;
        // ì‹œì‘ì¼ ì´í›„ë§Œ ë§¤ìˆ˜
        if (p.date >= startDateStr) isContribution.add(p.date);
      }
    }
    return isContribution;
  }

  function toNum(x) {
    const n = Number(x);
    return Number.isFinite(n) ? n : 0;
  }

  function updateChart(labels, principal, capGain, divNet, total) {
    const ctx = document.getElementById('unifiedChart').getContext('2d');
    if (unifiedChart) unifiedChart.destroy();

    unifiedChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'ì›ê¸ˆ', data: principal, stack: 'a', fill: true, pointRadius: 0 },
          { label: 'ê°€ê²© íš¨ê³¼', data: capGain, stack: 'a', fill: true, pointRadius: 0 },
          { label: 'ë°°ë‹¹(ì„¸í›„)', data: divNet, stack: 'a', fill: true, pointRadius: 0 },
          { label: 'ì´ìì‚°', data: total, borderWidth: 2, fill: false, pointRadius: 0 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            stacked: true,
            ticks: { callback: v => Math.round(v / 100000000) + "ì–µ" }
          }
        }
      }
    });
  }

  async function runBacktest() {
    const ticker = document.getElementById('ticker').value.trim() || "SCHD";

    const startInput = document.getElementById('startDate').value;
    if (!startInput) {
      alert("ì‹œì‘ì¼ì„ ì„ íƒí•´ì¤˜!");
      return;
    }

    const freq = document.getElementById('freq').value;
    const buyKRW = toNum(document.getElementById('buyKRW').value);
    const fx = Math.max(1, toNum(document.getElementById('fx').value));
    const taxRate = Math.max(0, toNum(document.getElementById('tax').value) / 100);
    const drip = document.getElementById('drip').checked;

    const end = ymd(new Date());

    // 1) ì„œë²„ì—ì„œ ê°€ê²©/ë°°ë‹¹ ë°ì´í„° ë¡œë“œ
    const data = await fetchHistory(ticker, startInput, end);

    const pricesAll = data.prices || [];
    const divsAll = data.dividends || [];

    if (pricesAll.length < 10) {
      alert("ê°€ê²© ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ìš”. í‹°ì»¤/ê¸°ê°„ì„ í™•ì¸í•´ì¤˜.");
      return;
    }

    // ì‹¤ì œ ê°€ëŠ¥í•œ ì‹œì‘ì¼
    const firstAvailable = data.firstDate || pricesAll[0].date;
    const startDate = (startInput < firstAvailable) ? firstAvailable : startInput;

    document.getElementById("dataNotice").innerText =
      `ë°ì´í„° ë²”ìœ„: ${data.firstDate || "-"} ~ ${data.lastDate || "-"} / ê³„ì‚° ì‹œì‘: ${startDate}`;

    // 2) ì‹œì‘ì¼ ì´í›„ë§Œ ì‚¬ìš©
    const prices = pricesAll.filter(p => p.date >= startDate);

    // 3) ë°°ë‹¹ ì´ë²¤íŠ¸ ë§µ (date -> perShare)
    const divMap = new Map();
    for (const d of divsAll) {
      if (!d?.date) continue;
      const amt = toNum(d.amount);
      if (amt <= 0) continue;
      // ê°™ì€ ë‚ ì§œ ì¤‘ë³µì´ë©´ í•©ì‚°
      divMap.set(d.date, (divMap.get(d.date) || 0) + amt);
    }

    // 4) ë§¤ìˆ˜ì¼ ê²°ì •
    const contributeSet = buildContributionSet(prices, freq, startDate);

    // 5) ì‹œë®¬ë ˆì´ì…˜(USD ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚° í›„ KRW ë³€í™˜)
    const buyUSD = buyKRW / fx;

    let shares = 0;
    let principalUSD = 0;
    let divNetUSD = 0;
    let cashUSD = 0; // DRIP OFFì¼ ë•Œ ë°°ë‹¹ í˜„ê¸ˆ ë³´ê´€

    // ì›”ë³„ ìŠ¤ëƒ…ìƒ·
    const months = [];
    let currentMonth = null;

    let monthDivNetUSD = 0;

    for (let i = 0; i < prices.length; i++) {
      const { date, close } = prices[i];
      const mk = monthKey(date);

      if (currentMonth === null) {
        currentMonth = mk;
      } else if (mk !== currentMonth) {
        // ì´ì „ ì›” ë§ˆê° ìŠ¤ëƒ…ìƒ· ì €ì¥ (ì „ë‚  close ê¸°ì¤€)
        const prev = prices[i - 1];
        const valueUSD = shares * prev.close + cashUSD;
        const capGainUSD = valueUSD - principalUSD - divNetUSD;

        months.push({
          key: currentMonth,
          endDate: prev.date,
          principalUSD,
          divNetUSD,
          capGainUSD,
          valueUSD,
          monthDivNetUSD,
          shares,
        });

        // ë‹¤ìŒ ì›” ì‹œì‘
        currentMonth = mk;
        monthDivNetUSD = 0;
      }

      // (A) ë§¤ìˆ˜
      if (contributeSet.has(date)) {
        shares += (buyUSD / close);
        principalUSD += buyUSD;
      }

      // (B) ë°°ë‹¹ ì´ë²¤íŠ¸ (í•´ë‹¹ ë‚ ì§œì— ì§€ê¸‰ëœ ê²ƒìœ¼ë¡œ ì²˜ë¦¬)
      const perShare = divMap.get(date) || 0;
      if (perShare > 0) {
        const gross = shares * perShare;
        const net = gross * (1 - taxRate);
        divNetUSD += net;
        monthDivNetUSD += net;

        if (drip) {
          shares += (net / close);
        } else {
          cashUSD += net;
        }
      }
    }

    // ë§ˆì§€ë§‰ ì›” ìŠ¤ëƒ…ìƒ·
    const last = prices[prices.length - 1];
    const valueUSD = shares * last.close + cashUSD;
    const capGainUSD = valueUSD - principalUSD - divNetUSD;

    months.push({
      key: currentMonth,
      endDate: last.date,
      principalUSD,
      divNetUSD,
      capGainUSD,
      valueUSD,
      monthDivNetUSD,
      shares,
    });

    // 6) í™”ë©´ í‘œì‹œ (KRW ë³€í™˜)
    const labels = ["ì‹œì‘"];
    const pData = [0];
    const gData = [0];
    const dData = [0];
    const tData = [0];

    const tableBody = document.getElementById("tableBody");
    tableBody.innerHTML = "";

    // ì—°ë„/ì›” grouping
    const byYear = new Map();
    for (const m of months) {
      const year = m.key.slice(0,4);
      if (!byYear.has(year)) byYear.set(year, []);
      byYear.get(year).push(m);
    }

    // ê²°ê³¼ ì¹´ë“œ
    document.getElementById("resTotal").innerText = fmtKRW(valueUSD * fx);
    document.getElementById("resProfit").innerText = fmtKRW((valueUSD - principalUSD) * fx);
    document.getElementById("resDiv").innerText = fmtKRW(divNetUSD * fx);
    document.getElementById("resShares").innerText = (shares).toFixed(4) + " ì£¼";

    // í‘œ ìƒì„± (ì—°ë„ í´ë¦­ -> ì›” í† ê¸€)
    const years = Array.from(byYear.keys()).sort();
    for (const y of years) {
      const list = byYear.get(y);

      // ì—°ë„ ë§ˆì§€ë§‰ ë‹¬ ê¸°ì¤€ ìš”ì•½
      const yLast = list[list.length - 1];
      const yPrincipalKRW = yLast.principalUSD * fx;
      const yDivKRW = yLast.divNetUSD * fx;
      const yCapGainKRW = yLast.capGainUSD * fx;
      const yValueKRW = yLast.valueUSD * fx;

      // ì°¨íŠ¸ëŠ” ì—°ë‹¨ìœ„ë¡œ ì°ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ push, ì§€ê¸ˆì€ ì›”ë‹¨ìœ„ë¡œ ë” ì´˜ì´˜í•˜ê²Œ
      // -> ì›”ë‹¨ìœ„ ì°¨íŠ¸
      for (const mm of list) {
        labels.push(mm.key);
        pData.push(mm.principalUSD * fx);
        gData.push(mm.capGainUSD * fx);
        dData.push(mm.divNetUSD * fx);
        tData.push(mm.valueUSD * fx);
      }

      // ì—°ë„í–‰
      const yearKey = `y${y}`;
      tableBody.innerHTML += `
        <tr class="year-header border-b hover:bg-blue-50 cursor-pointer" onclick="toggleMonths('${yearKey}')">
          <td class="p-3 font-bold text-blue-700">â–¶ ${y}ë…„</td>
          <td class="p-3">${fmtKRW(yPrincipalKRW)}</td>
          <td class="p-3 text-emerald-600 font-semibold">${fmtKRW(yCapGainKRW)}</td>
          <td class="p-3 text-amber-600 font-semibold">${fmtKRW(yDivKRW)}</td>
          <td class="p-3 font-black text-slate-900 bg-slate-50">${fmtKRW(yValueKRW)}</td>
          <td class="p-3 font-bold text-gray-700">-</td>
        </tr>
      `;

      // ì›”í–‰(ìˆ¨ê¹€/í† ê¸€)
      for (const mm of list) {
        const principalKRW = mm.principalUSD * fx;
        const divKRW = mm.divNetUSD * fx;
        const capGainKRW = mm.capGainUSD * fx;
        const valueKRW = mm.valueUSD * fx;
        const monthDivKRW = mm.monthDivNetUSD * fx;

        tableBody.innerHTML += `
          <tr class="month-row month-${yearKey} bg-gray-50 border-b text-gray-500 text-xs">
            <td class="p-2 pl-8 font-medium text-blue-400">ã„´ ${mm.key}</td>
            <td class="p-2">${fmtKRW(principalKRW)}</td>
            <td class="p-2">${fmtKRW(capGainKRW)}</td>
            <td class="p-2">${fmtKRW(divKRW)}</td>
            <td class="p-2 font-bold">${fmtKRW(valueKRW)}</td>
            <td class="p-2 text-amber-500">${fmtKRW(monthDivKRW)}</td>
          </tr>
        `;
      }
    }

    updateChart(labels, pData, gData, dData, tData);
  }

  // ì‹œì‘ì¼ ê¸°ë³¸ê°’: ëŒ€ì¶© 2012-01-01 (SCHDëŠ” 2000ë…„ë¶€í„°ëŠ” ë¶ˆê°€í•œ í¸)
  document.getElementById("startDate").value = "2012-01-01";
</script>
</body>
</html>
