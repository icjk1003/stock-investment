<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SCHD ê³¼ê±° ëˆ„ì ë§¤ìˆ˜ ë°±í…ŒìŠ¤íŠ¸ | í†µí•© ìì‚° ì‹œë®¬ë ˆì´í„°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
    body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
    .month-row { display: none; }
    .month-row.active { display: table-row; }
  </style>
</head>

<body class="p-4 md:p-8">
  <div class="max-w-6xl mx-auto">
    <header class="mb-8 text-center">
      <h1 class="text-3xl font-bold text-blue-700">SCHD ê³¼ê±° ëˆ„ì ë§¤ìˆ˜ ë°±í…ŒìŠ¤íŠ¸ ğŸ“ˆ</h1>
      <p class="text-gray-600 mt-2">
        ê³¼ê±° ì‹œì‘ì¼ë¶€í„° ë§¤ì›”/ë§¤ì¼ ë§¤ìˆ˜í–ˆì„ ë•Œ, ê°€ê²©/ë°°ë‹¹/í™˜ìœ¨(ìë™)ì„ ë°˜ì˜í•œ ëˆ„ì  ì„±ê³¼ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤
      </p>
      <p id="dataNotice" class="text-xs text-gray-400 mt-2"></p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Left: Inputs -->
      <div class="lg:col-span-1">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
          <h2 class="text-xl font-semibold border-b pb-2 text-gray-800">íˆ¬ì ì„¤ì •</h2>

          <div>
            <label class="block text-xs font-medium text-gray-500">í‹°ì»¤</label>
            <input type="text" id="ticker" value="SCHD"
              class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
            <p class="text-[11px] text-gray-400 mt-1">ê¸°ë³¸: SCHD (ë¯¸êµ­ ETF)</p>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500">ì‹œì‘ì¼</label>
            <input type="date" id="startDate"
              class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
            <p class="text-[11px] text-gray-400 mt-1">íœ´ì¥ì¼ì´ë©´ íŒì—… ì•ˆë‚´ í›„ ê±°ë˜ì¼ë¡œ ìë™ ë³´ì •ë©ë‹ˆë‹¤.</p>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500">ë§ˆì§€ë§‰ì¼</label>
            <input type="date" id="endDate"
              class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
            <p class="text-[11px] text-gray-400 mt-1">íœ´ì¥ì¼ì´ë©´ íŒì—… ì•ˆë‚´ í›„ ê±°ë˜ì¼ë¡œ ìë™ ë³´ì •ë©ë‹ˆë‹¤.</p>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500">ë§¤ìˆ˜ ì£¼ê¸°</label>
            <select id="freq" class="w-full mt-1 p-2 border rounded-md outline-blue-500">
              <option value="monthly" selected>ë§¤ì›” (í•´ë‹¹ ì›” ì²« ê±°ë˜ì¼)</option>
              <option value="daily">ë§¤ì¼ (ê±°ë˜ì¼ ê¸°ì¤€)</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500">ë§¤ìˆ˜ ê¸ˆì•¡ (ì›, KRW)</label>
            <input type="number" id="buyKRW" value="2000000"
              class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
            <p class="text-[11px] text-gray-400 mt-1">ë§¤ìˆ˜ì¼ì˜ USD/KRW í™˜ìœ¨ì„ ìë™ ì ìš©í•´ USDë¡œ í™˜ì‚° í›„ ë§¤ìˆ˜í•©ë‹ˆë‹¤.</p>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500">ë°°ë‹¹ì„¸ìœ¨ (%)</label>
            <input type="number" id="tax" value="15" step="0.1"
              class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
          </div>

          <div class="flex items-center gap-2">
            <input type="checkbox" id="drip" checked class="h-4 w-4"/>
            <label for="drip" class="text-sm text-gray-700 font-semibold">ë°°ë‹¹ ì¬íˆ¬ì(DRIP)</label>
          </div>

          <button onclick="runBacktest()"
            class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">
            ê³„ì‚°í•˜ê¸°
          </button>

          <p class="text-[11px] text-gray-400 leading-relaxed">
            * ê°€ê²©/ë°°ë‹¹/í™˜ìœ¨ ë°ì´í„°ëŠ” ì„œë²„(Firebase Functions)ì—ì„œ ì¡°íšŒí•©ë‹ˆë‹¤.<br/>
            * ì‹œì‘ì¼/ë§ˆì§€ë§‰ì¼ì´ íœ´ì¥ì¼ì´ë©´ íŒì—…ìœ¼ë¡œ ì•ˆë‚´ í›„ ìë™ìœ¼ë¡œ ê±°ë˜ì¼ë¡œ ë³´ì •í•©ë‹ˆë‹¤.<br/>
            * â€œì›” ë°°ë‹¹ê¸ˆâ€ì€ ì‹¤ì œ ë¶„ê¸°ë°°ë‹¹(ì§€ê¸‰ì›”)ì„ 3ê°œì›”ë¡œ ë‚˜ëˆ  ë°°ë¶„í•œ ê°’ì…ë‹ˆë‹¤(ê²½ê³„ ë³´ì • í¬í•¨).
          </p>
        </div>
      </div>

      <!-- Right: Chart + summary -->
      <div class="lg:col-span-3 space-y-6">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <div style="position: relative; height:450px; width:100%">
            <canvas id="unifiedChart"></canvas>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
          <div class="bg-slate-900 p-5 rounded-2xl text-white shadow-lg">
            <p class="text-slate-400 text-xs uppercase">ìµœì¢… ìì‚°</p>
            <p id="resTotal" class="text-xl font-bold mt-1">-</p>
          </div>
          <div class="bg-emerald-600 p-5 rounded-2xl text-white shadow-lg">
            <p class="text-emerald-100 text-xs uppercase">ëˆ„ì  ìˆ˜ìµ</p>
            <p id="resProfit" class="text-xl font-bold mt-1">-</p>
          </div>
          <div class="bg-amber-500 p-5 rounded-2xl text-white shadow-lg">
            <p class="text-amber-50 text-xs uppercase">ìµœì¢… ì›” ë°°ë‹¹</p>
            <p id="resMonthlyDiv" class="text-xl font-bold mt-1">-</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="mt-8 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 overflow-x-auto">
      <h2 class="text-xl font-semibold mb-4 border-b pb-2">ì—°ë„ë³„ ìƒì„¸ ë°ì´í„°</h2>
      <table class="w-full text-left text-sm border-collapse">
        <thead>
          <tr class="bg-gray-100 text-gray-600 border-b text-xs uppercase">
            <th class="p-3">ì—°ì°¨/ì›”</th>
            <th class="p-3">ëˆ„ì  ì›ê¸ˆ</th>
            <th class="p-3 text-emerald-600">ëˆ„ì  ì‹œì„¸ì°¨ìµ</th>
            <th class="p-3 text-amber-600">ëˆ„ì  ë°°ë‹¹ìˆ˜ìµ(ì„¸í›„)</th>
            <th class="p-3 font-bold text-slate-900">ì´ í‰ê°€ìì‚°</th>
            <th class="p-3">ì›” ë°°ë‹¹ê¸ˆ(ì„¸í›„)</th>
            <th class="p-3">ë¶„ê¸° ë°°ë‹¹ê¸ˆ(ì„¸í›„)</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <footer class="mt-16 py-8 text-center text-xs text-gray-400 border-t">
      Â© 2026 SCHD Asset Simulator Â· Contact: icjk1003@gmail.com
    </footer>
  </div>

<script>
  let unifiedChart;

  function ymd(d) {
    const x = new Date(d);
    return x.toISOString().slice(0, 10);
  }
  function isDateStr(x) {
    return /^\d{4}-\d{2}-\d{2}$/.test(x);
  }
  function addDays(dateStr, days) {
    const d = new Date(dateStr + "T00:00:00Z");
    d.setUTCDate(d.getUTCDate() + days);
    return d.toISOString().slice(0, 10);
  }
  function monthKey(dateStr) {
    return dateStr.slice(0,7);
  }
  function fmtKRW(v) {
    return Math.round(v).toLocaleString() + "ì›";
  }
  function toNum(x) {
    const n = Number(x);
    return Number.isFinite(n) ? n : 0;
  }
  function toggleMonths(key) {
    document.querySelectorAll(`.month-${key}`).forEach(r => r.classList.toggle('active'));
  }

  // âœ… "YYYY-MM"ì— ì›” ë”í•˜ê¸°/ë¹¼ê¸°
  function addMonthsToKey(ym, delta) {
    const y = Number(ym.slice(0, 4));
    const m = Number(ym.slice(5, 7));
    const d = new Date(Date.UTC(y, m - 1 + delta, 1));
    return d.toISOString().slice(0, 7);
  }

  // direction: "next"(ì‹œì‘ì¼ìš©) / "prev"(ë§ˆì§€ë§‰ì¼ìš©)
  function clampToNearestTradingDay(pricesAll, dateStr, direction) {
    if (!pricesAll?.length) return null;
    if (!isDateStr(dateStr)) return null;

    if (direction === "next") {
      return pricesAll.find(p => p.date >= dateStr)?.date || null;
    } else {
      for (let i = pricesAll.length - 1; i >= 0; i--) {
        if (pricesAll[i].date <= dateStr) return pricesAll[i].date;
      }
      return null;
    }
  }

  async function fetchHistory(ticker, start, end) {
    const url = `/api/schdHistory?ticker=${encodeURIComponent(ticker)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error("ê°€ê²©/ë°°ë‹¹ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: " + (await r.text()));
    return r.json();
  }

  async function fetchFX(start, end) {
    const url = `/api/fxHistory?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error("í™˜ìœ¨ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: " + (await r.text()));
    return r.json();
  }

  function buildContributionSet(prices, freq, startDateStr) {
    const isContribution = new Set();

    if (freq === "daily") {
      for (const p of prices) isContribution.add(p.date);
      return isContribution;
    }

    // monthly: ê° ì›”ì˜ ì²« ê±°ë˜ì¼ë§Œ
    let lastMonth = null;
    for (const p of prices) {
      const mk = monthKey(p.date);
      if (mk !== lastMonth) {
        lastMonth = mk;
        if (p.date >= startDateStr) isContribution.add(p.date);
      }
    }
    return isContribution;
  }

  function updateChart(labels, p, g, d, t) {
    const ctx = document.getElementById('unifiedChart').getContext('2d');
    if (unifiedChart) unifiedChart.destroy();

    unifiedChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'ì›ê¸ˆ', data: p, stack: 'a', fill: true, pointRadius: 0 },
          { label: 'ì‹œì„¸ì°¨ìµ', data: g, stack: 'a', fill: true, pointRadius: 0 },
          { label: 'ë°°ë‹¹ìˆ˜ìµ(ì„¸í›„)', data: d, stack: 'a', fill: true, pointRadius: 0 },
          { label: 'ì´ìì‚°', data: t, borderWidth: 2, fill: false, pointRadius: 0 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            stacked: true,
            ticks: { callback: v => Math.round(v / 100000000) + "ì–µ" }
          }
        }
      }
    });
  }

  function normalizeDateKey(d) {
    if (!d) return null;
    return String(d).slice(0, 10);
  }

  function pickFxValue(p) {
    const v =
      p?.close ?? p?.rate ?? p?.value ?? p?.fx ?? p?.price ?? p?.adjClose ?? p?.adj_close;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function buildFXMap(fxPrices) {
    const map = new Map();
    for (const p of fxPrices || []) {
      const k = normalizeDateKey(p?.date);
      const n = pickFxValue(p);
      if (k && n && n > 0) map.set(k, n);
    }
    return map;
  }

  // âœ… FX: ë‹¹ì¼ ì—†ìœ¼ë©´ ì£¼ë³€ì—ì„œ ì°¾ì•„ì˜¤ê¸° (ë³´ì •)
  function getFXSmart(dateStr, fxMap, fxDatesSorted) {
    if (fxMap.has(dateStr)) return fxMap.get(dateStr);

    const next = addDays(dateStr, +1);
    if (fxMap.has(next)) return fxMap.get(next);

    for (let k = 1; k <= 7; k++) {
      const prev = addDays(dateStr, -k);
      if (fxMap.has(prev)) return fxMap.get(prev);
    }

    let lo = 0, hi = fxDatesSorted.length - 1, ans = -1;
    while (lo <= hi) {
      const mid = (lo + hi) >> 1;
      if (fxDatesSorted[mid] <= dateStr) { ans = mid; lo = mid + 1; }
      else { hi = mid - 1; }
    }
    if (ans >= 0) return fxMap.get(fxDatesSorted[ans]);

    return fxMap.get(fxDatesSorted[0]) || null;
  }

  function getFXForMonthEnd(endDateStr, fxMap, fxDatesSorted) {
    return getFXSmart(endDateStr, fxMap, fxDatesSorted);
  }

  // âœ… ê²½ê³„ ë³´ì •í˜•: "ì›” ë°°ë‹¹ê¸ˆ" í•©ì´ "ë¶„ê¸° ë°°ë‹¹ê¸ˆ" í•©ê³¼ ê¸°ê°„ ë‚´ì—ì„œ ë§ë„ë¡ ë°°ë¶„
  function buildMonthlyDivAllocatedUSD(months) {
    const n = months.length;
    const alloc = new Array(n).fill(0);

    for (let i = 0; i < n; i++) {
      const q = months[i].monthDivNetUSD || 0;
      if (q <= 0) continue;

      // ê¸°ë³¸: í˜„ì¬ì›” + ì´ì „ 2ê°œì›”
      const candidate = [i, i - 1, i - 2];

      // ê¸°ê°„ ë°– ì œê±°
      let picked = candidate.filter(idx => idx >= 0 && idx < n);

      // ë¶€ì¡±í•˜ë©´ ì•ìœ¼ë¡œ ì±„ì›Œì„œ 3ê°œ ë§ì¶”ê¸°
      let next = i + 1;
      while (picked.length < 3 && next < n) {
        if (!picked.includes(next)) picked.push(next);
        next++;
      }

      // ê·¸ë˜ë„ ë¶€ì¡±í•˜ë©´ ê°€ëŠ¥í•œ ë‹¬ë§Œ ê· ë“± ë¶„ë°°
      const k = picked.length;
      if (k === 0) continue;

      const part = q / k;
      for (const idx of picked) alloc[idx] += part;
    }

    return alloc;
  }

  async function runBacktest() {
    const ticker = document.getElementById('ticker').value.trim() || "SCHD";

    let startInput = document.getElementById('startDate').value;
    let endInput = document.getElementById('endDate').value;

    if (!startInput) { alert("ì‹œì‘ì¼ì„ ì„ íƒí•´ì¤˜!"); return; }
    if (!endInput) { alert("ë§ˆì§€ë§‰ì¼ì„ ì„ íƒí•´ì¤˜!"); return; }
    if (endInput < startInput) { alert("ë§ˆì§€ë§‰ì¼ì€ ì‹œì‘ì¼ë³´ë‹¤ ì´í›„ì—¬ì•¼ í•´!"); return; }

    const freq = document.getElementById('freq').value;
    const buyKRW = Math.max(0, toNum(document.getElementById('buyKRW').value));
    const taxRate = Math.max(0, toNum(document.getElementById('tax').value) / 100);
    const drip = document.getElementById('drip').checked;

    // 1) ê°€ê²©/ë°°ë‹¹ ë°ì´í„°: ì‚¬ìš©ìê°€ ê³ ë¥¸ ë²”ìœ„ë¡œ ìš”ì²­
    const data = await fetchHistory(ticker, startInput, endInput);
    const pricesAll = data.prices || [];
    const divsAll = data.dividends || [];

    if (pricesAll.length < 10) {
      alert("ê°€ê²© ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ìš”. í‹°ì»¤/ê¸°ê°„ì„ í™•ì¸í•´ì¤˜.");
      return;
    }

    // 2) ì‹œì‘/ëì„ ê±°ë˜ì¼ë¡œ ë³´ì •
    const firstAvailable = data.firstDate || pricesAll[0].date;
    const lastAvailable = data.lastDate || pricesAll[pricesAll.length - 1].date;

    if (startInput < firstAvailable) startInput = firstAvailable;
    if (endInput > lastAvailable) endInput = lastAvailable;

    const startAdj = clampToNearestTradingDay(pricesAll, startInput, "next");
    const endAdj = clampToNearestTradingDay(pricesAll, endInput, "prev");

    if (!startAdj || !endAdj) {
      alert("ê±°ë˜ì¼ ë³´ì •ì— ì‹¤íŒ¨í–ˆì–´ìš”. ê¸°ê°„ì„ ë‹¤ì‹œ ì„ íƒí•´ì¤˜.");
      return;
    }

    if (startAdj !== startInput) {
      alert(`ì‹œì‘ì¼ ${startInput}ì€(ëŠ”) íœ´ì¥ì¼/ë¹„ê±°ë˜ì¼ì…ë‹ˆë‹¤.\nê°€ì¥ ê°€ê¹Œìš´ ê±°ë˜ì¼ ${startAdj}ë¡œ ìë™ ì„¤ì •í•©ë‹ˆë‹¤.`);
    }
    if (endAdj !== endInput) {
      alert(`ë§ˆì§€ë§‰ì¼ ${endInput}ì€(ëŠ”) íœ´ì¥ì¼/ë¹„ê±°ë˜ì¼ì…ë‹ˆë‹¤.\nê°€ì¥ ê°€ê¹Œìš´ ê±°ë˜ì¼ ${endAdj}ë¡œ ìë™ ì„¤ì •í•©ë‹ˆë‹¤.`);
    }

    const startDate = startAdj;
    const endDate = endAdj;

    document.getElementById('startDate').value = startDate;
    document.getElementById('endDate').value = endDate;

    if (endDate < startDate) {
      alert("ë³´ì • ê²°ê³¼ ë§ˆì§€ë§‰ì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ì•ì´ ë˜ì–´ ê³„ì‚°í•  ìˆ˜ ì—†ì–´ìš”. ë‚ ì§œë¥¼ ë‹¤ì‹œ ê³¨ë¼ì¤˜.");
      return;
    }

    const prices = pricesAll.filter(p => p.date >= startDate && p.date <= endDate);

    // 3) í™˜ìœ¨ ë°ì´í„°: startDateë³´ë‹¤ 30ì¼ ì•ë¶€í„° ë²„í¼ë¡œ ìš”ì²­
    const fxStart = addDays(startDate, -30);
    const fxData = await fetchFX(fxStart, endDate);

    const fxPrices = fxData.prices || [];
    if (fxPrices.length < 5) {
      alert("í™˜ìœ¨ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì¤˜.");
      return;
    }

    const fxMap = buildFXMap(fxPrices);
    const fxDatesSorted = Array.from(fxMap.keys()).sort();

    if (fxDatesSorted.length === 0) {
      alert("í™˜ìœ¨ ë°ì´í„°ê°€ 0ê°œë¡œ íŒŒì‹±ë˜ì—ˆìŠµë‹ˆë‹¤. fxHistory ì‘ë‹µ í•„ë“œ(date/close)ë¥¼ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.");
      return;
    }

    // 4) ë°°ë‹¹ ì´ë²¤íŠ¸ ë§µ (date -> perShare)
    const divMap = new Map();
    for (const d of divsAll) {
      if (!d?.date) continue;
      const amt = toNum(d.amount);
      if (amt <= 0) continue;
      divMap.set(d.date, (divMap.get(d.date) || 0) + amt);
    }

    // 5) ë§¤ìˆ˜ì¼ ê²°ì •
    const contributeSet = buildContributionSet(prices, freq, startDate);

    // 6) ì‹œë®¬ë ˆì´ì…˜
    let shares = 0;
    let principalKRW = 0; // ëˆ„ì  ì›ê¸ˆ(KRW ê³ ì •)
    let principalUSD = 0; // USD ì›ê¸ˆ(í‰ê°€/ì‹œì„¸ì°¨ìµ ê³„ì‚°)

    let divNetUSD = 0;
    let cashUSD = 0; // DRIP OFFì¼ ë•Œ ë°°ë‹¹ í˜„ê¸ˆ

    const months = [];
    let currentMonth = null;
    let monthDivNetUSD = 0;

    for (let i = 0; i < prices.length; i++) {
      const { date, close } = prices[i];
      const mk = monthKey(date);

      if (currentMonth === null) {
        currentMonth = mk;
      } else if (mk !== currentMonth) {
        const prev = prices[i - 1];
        const valueUSD = shares * prev.close + cashUSD;
        const capGainUSD = valueUSD - principalUSD - divNetUSD;

        months.push({
          key: currentMonth,
          endDate: prev.date,
          principalKRW,
          principalUSD,
          divNetUSD,
          capGainUSD,
          valueUSD,
          monthDivNetUSD, // ê·¸ ë‹¬ ì‹¤ì œ ë¶„ê¸°ë°°ë‹¹(ì„¸í›„)
          shares,
        });

        currentMonth = mk;
        monthDivNetUSD = 0;
      }

      const fx = getFXSmart(date, fxMap, fxDatesSorted);
      if (!fx || fx <= 0) {
        alert(`í™˜ìœ¨ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤: ${date}`);
        return;
      }

      // (A) ë§¤ìˆ˜
      if (contributeSet.has(date)) {
        const buyUSD = buyKRW / fx;
        shares += (buyUSD / close);
        principalKRW += buyKRW;
        principalUSD += buyUSD;
      }

      // (B) ë°°ë‹¹ ì´ë²¤íŠ¸
      const perShare = divMap.get(date) || 0;
      if (perShare > 0) {
        const gross = shares * perShare;
        const net = gross * (1 - taxRate);
        divNetUSD += net;
        monthDivNetUSD += net;

        if (drip) shares += (net / close);
        else cashUSD += net;
      }
    }

    // ë§ˆì§€ë§‰ ì›” ìŠ¤ëƒ…ìƒ·
    const last = prices[prices.length - 1];
    const lastValueUSD = shares * last.close + cashUSD;
    const lastCapGainUSD = lastValueUSD - principalUSD - divNetUSD;

    months.push({
      key: currentMonth,
      endDate: last.date,
      principalKRW,
      principalUSD,
      divNetUSD,
      capGainUSD: lastCapGainUSD,
      valueUSD: lastValueUSD,
      monthDivNetUSD,
      shares,
    });

    // âœ… ì›”ë°°ë‹¹(ë¶„ê¸°ë°°ë‹¹ 3ê°œì›” ë¶„ë°°, ê²½ê³„ ë³´ì •)
    const monthlyAllocUSD = buildMonthlyDivAllocatedUSD(months);

    // ì›”ë§ í™˜ìœ¨
    function monthEndFX(endDateStr) {
      return getFXForMonthEnd(endDateStr, fxMap, fxDatesSorted) || 1300;
    }

    const finalFX = monthEndFX(last.date);
    const finalValueKRW = lastValueUSD * finalFX;
    const finalProfitKRW = (lastValueUSD - principalUSD) * finalFX;

    // âœ… ìµœì¢… ì›” ë°°ë‹¹: "ë§ˆì§€ë§‰ ë‹¬ì— ë°°ë¶„ëœ ì›”ë°°ë‹¹"
    const finalMonthlyDivKRW = (monthlyAllocUSD[months.length - 1] || 0) * finalFX;

    document.getElementById("resTotal").innerText = fmtKRW(finalValueKRW);
    document.getElementById("resProfit").innerText = fmtKRW(finalProfitKRW);
    document.getElementById("resMonthlyDiv").innerText = fmtKRW(finalMonthlyDivKRW);

    document.getElementById("dataNotice").innerText =
      `ê°€ê²© ë°ì´í„°: ${data.firstDate || "-"} ~ ${data.lastDate || "-"} / ê³„ì‚°: ${startDate} ~ ${endDate} / í™˜ìœ¨: ${fxData.symbol || "USD/KRW"}`;

    // 7) í‘œ/ì°¨íŠ¸ ë°ì´í„°
    const labels = ["ì‹œì‘"];
    const pData = [0];
    const gData = [0];
    const dData = [0];
    const tData = [0];

    const tableBody = document.getElementById("tableBody");
    tableBody.innerHTML = "";

    // ì—°ë„ grouping
    const byYear = new Map();
    for (let i = 0; i < months.length; i++) {
      const m = months[i];
      const year = m.key.slice(0,4);
      if (!byYear.has(year)) byYear.set(year, []);
      byYear.get(year).push({ ...m, idx: i });
    }

    const years = Array.from(byYear.keys()).sort();
    for (const y of years) {
      const list = byYear.get(y);
      const yLast = list[list.length - 1];
      const yFX = monthEndFX(yLast.endDate);

      const yPrincipalKRW = yLast.principalKRW;
      const yDivKRW = yLast.divNetUSD * yFX;
      const yCapGainKRW = yLast.capGainUSD * yFX;
      const yValueKRW = yLast.valueUSD * yFX;

      const yearKey = `y${y}`;

      tableBody.innerHTML += `
        <tr class="year-header border-b hover:bg-blue-50 cursor-pointer" onclick="toggleMonths('${yearKey}')">
          <td class="p-3 font-bold text-blue-700">â–¶ ${y}ë…„</td>
          <td class="p-3">${fmtKRW(yPrincipalKRW)}</td>
          <td class="p-3 text-emerald-600 font-semibold">${fmtKRW(yCapGainKRW)}</td>
          <td class="p-3 text-amber-600 font-semibold">${fmtKRW(yDivKRW)}</td>
          <td class="p-3 font-black text-slate-900 bg-slate-50">${fmtKRW(yValueKRW)}</td>
          <td class="p-3 font-bold text-gray-700">-</td>
          <td class="p-3 font-bold text-gray-700">-</td>
        </tr>
      `;

      for (const mm of list) {
        const fx = monthEndFX(mm.endDate);

        const principalKRW_m = mm.principalKRW;
        const divKRW_m = mm.divNetUSD * fx;
        const capGainKRW_m = mm.capGainUSD * fx;
        const valueKRW_m = mm.valueUSD * fx;

        // ë¶„ê¸°ë°°ë‹¹(ê·¸ ë‹¬ ì‹¤ì œ ì§€ê¸‰ëœ ë°°ë‹¹)
        const quarterDivKRW = (mm.monthDivNetUSD || 0) * fx;

        // âœ… ì›”ë°°ë‹¹(ë°°ë¶„ëœ ê°’)
        const monthlyDivKRW = (monthlyAllocUSD[mm.idx] || 0) * fx;

        // ì°¨íŠ¸: ì›”ë‹¨ìœ„
        labels.push(mm.key);
        pData.push(principalKRW_m);
        gData.push(capGainKRW_m);
        dData.push(divKRW_m);
        tData.push(valueKRW_m);

        const quarterDivText = (quarterDivKRW > 0) ? fmtKRW(quarterDivKRW) : "-";

        tableBody.innerHTML += `
          <tr class="month-row month-${yearKey} bg-gray-50 border-b text-gray-500 text-xs">
            <td class="p-2 pl-8 font-medium text-blue-400">ã„´ ${mm.key}</td>
            <td class="p-2">${fmtKRW(principalKRW_m)}</td>
            <td class="p-2">${fmtKRW(capGainKRW_m)}</td>
            <td class="p-2">${fmtKRW(divKRW_m)}</td>
            <td class="p-2 font-bold">${fmtKRW(valueKRW_m)}</td>
            <td class="p-2 text-amber-500">${fmtKRW(monthlyDivKRW)}</td>
            <td class="p-2 text-amber-500">${quarterDivText}</td>
          </tr>
        `;
      }
    }

    updateChart(labels, pData, gData, dData, tData);
  }

  // ê¸°ë³¸ê°’:
  // - ë§ˆì§€ë§‰ì¼: ì˜¤ëŠ˜
  // - ì‹œì‘ì¼: SCHDì˜ â€œì‹¤ì œ ì²« ê±°ë˜ì¼â€ì„ í˜ì´ì§€ ë¡œë“œì‹œ 1íšŒ ì¡°íšŒí•´ì„œ ìë™ ì„¸íŒ…
  (async function initDefaults() {
    document.getElementById("endDate").value = ymd(Date.now());

    try {
      const ticker = "SCHD";
      const end = ymd(Date.now());
      const data = await fetchHistory(ticker, "2011-01-01", end);
      const pricesAll = data.prices || [];
      const first = data.firstDate || (pricesAll[0]?.date);
      if (first) {
        document.getElementById("startDate").value = first;
        document.getElementById("dataNotice").innerText =
          `ê¸°ë³¸ ì‹œì‘ì¼(ì²« ê±°ë˜ì¼): ${first} / ê¸°ë³¸ ë§ˆì§€ë§‰ì¼: ${end}`;
      } else {
        document.getElementById("startDate").value = "2012-01-03";
      }
    } catch (e) {
      document.getElementById("startDate").value = "2012-01-03";
    }
  })();
</script>
</body>
</html>
