<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SCHD Backtest (DCA) | Asset Simulator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
    body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
    .month-row { display: none; }
    .month-row.active { display: table-row; }
  </style>
</head>

<body class="p-4 md:p-8">
  <div class="max-w-6xl mx-auto">
    <div class="flex justify-end mb-4">
      <a href="SCHD.html" class="text-sm font-bold text-gray-500 hover:text-blue-600 transition">üá∞üá∑ Korean Version (KRW) ‚Üí</a>
    </div>

    <header class="mb-8 text-center">
      <h1 class="text-3xl font-bold text-blue-700">SCHD Backtest (DCA) üìà</h1>
      <p class="text-gray-600 mt-2">
        If you bought SCHD from a past date with monthly/daily contributions, this shows cumulative performance with price & dividends (USD).
      </p>
      <p id="dataNotice" class="text-xs text-gray-400 mt-2"></p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Left: Inputs -->
      <div class="lg:col-span-1">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
          <h2 class="text-xl font-semibold border-b pb-2 text-gray-800">Settings (USD)</h2>

          <div>
            <label class="block text-xs font-medium text-gray-500">Ticker</label>
            <input type="text" id="ticker" value="SCHD"
              class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
            <p class="text-[11px] text-gray-400 mt-1">Default: SCHD</p>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500">Start Date</label>
            <input type="date" id="startDate"
              class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
            <p class="text-[11px] text-gray-400 mt-1">If market is closed, we auto-adjust to the nearest trading day (with a popup).</p>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500">End Date</label>
            <input type="date" id="endDate"
              class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
            <p class="text-[11px] text-gray-400 mt-1">If market is closed, we auto-adjust to the nearest trading day (with a popup).</p>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500">Contribution Frequency</label>
            <select id="freq" class="w-full mt-1 p-2 border rounded-md outline-blue-500">
              <option value="monthly" selected>Monthly (first trading day of month)</option>
              <option value="daily">Daily (trading days only)</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500">Contribution Amount (USD)</label>
            <input type="number" id="buyUSD" value="1500" step="1"
              class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
            <p class="text-[11px] text-gray-400 mt-1">Buys fractional shares using that day's close price.</p>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500">Dividend Tax Rate (%)</label>
            <input type="number" id="tax" value="15" step="0.1"
              class="w-full mt-1 p-2 border rounded-md outline-blue-500"/>
            <p class="text-[11px] text-gray-400 mt-1">If you want ‚Äúno withholding‚Äù, set 0%.</p>
          </div>

          <div class="flex items-center gap-2">
            <input type="checkbox" id="drip" checked class="h-4 w-4"/>
            <label for="drip" class="text-sm text-gray-700 font-semibold">Reinvest Dividends (DRIP)</label>
          </div>

          <button onclick="runBacktest()"
            class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">
            Calculate
          </button>

          <p class="text-[11px] text-gray-400 leading-relaxed">
            * Price/dividend data are fetched via Firebase Functions.<br/>
            * ‚ÄúMonthly Dividend‚Äù is allocated from quarterly dividends across 3 months (boundary-adjusted).
          </p>
        </div>
      </div>

      <!-- Right: Chart + summary -->
      <div class="lg:col-span-3 space-y-6">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <div style="position: relative; height:450px; width:100%">
            <canvas id="unifiedChart"></canvas>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
          <div class="bg-slate-900 p-5 rounded-2xl text-white shadow-lg">
            <p class="text-slate-400 text-xs uppercase">Final Value</p>
            <p id="resTotal" class="text-xl font-bold mt-1">-</p>
          </div>
          <div class="bg-emerald-600 p-5 rounded-2xl text-white shadow-lg">
            <p class="text-emerald-100 text-xs uppercase">Total Profit</p>
            <p id="resProfit" class="text-xl font-bold mt-1">-</p>
          </div>
          <div class="bg-amber-500 p-5 rounded-2xl text-white shadow-lg">
            <p class="text-amber-50 text-xs uppercase">Final Monthly Dividend</p>
            <p id="resMonthlyDiv" class="text-xl font-bold mt-1">-</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="mt-8 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 overflow-x-auto">
      <h2 class="text-xl font-semibold mb-4 border-b pb-2">Yearly Details</h2>
      <table class="w-full text-left text-sm border-collapse">
        <thead>
          <tr class="bg-gray-100 text-gray-600 border-b text-xs uppercase">
            <th class="p-3">Year/Month</th>
            <th class="p-3">Cumulative Principal</th>
            <th class="p-3 text-emerald-600">Cumulative Capital Gain</th>
            <th class="p-3 text-amber-600">Cumulative Dividends (Net)</th>
            <th class="p-3 font-bold text-slate-900">Total Value</th>
            <th class="p-3">Monthly Dividend (Net)</th>
            <th class="p-3">Quarterly Dividend (Net)</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <footer class="mt-16 py-8 text-center text-xs text-gray-400 border-t">
      ¬© 2026 SCHD Asset Simulator ¬∑ Contact: icjk1003@gmail.com
    </footer>
  </div>

<script>
  let unifiedChart;

  function ymd(d) {
    const x = new Date(d);
    return x.toISOString().slice(0, 10);
  }
  function isDateStr(x) {
    return /^\d{4}-\d{2}-\d{2}$/.test(x);
  }
  function monthKey(dateStr) { return dateStr.slice(0, 7); }
  function toNum(x) {
    const n = Number(x);
    return Number.isFinite(n) ? n : 0;
  }
  function fmtUSD(v) {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(v);
  }
  function toggleMonths(key) {
    document.querySelectorAll(`.month-${key}`).forEach(r => r.classList.toggle('active'));
  }

  // direction: "next"(start) / "prev"(end)
  function clampToNearestTradingDay(pricesAll, dateStr, direction) {
    if (!pricesAll?.length) return null;
    if (!isDateStr(dateStr)) return null;

    if (direction === "next") {
      return pricesAll.find(p => p.date >= dateStr)?.date || null;
    } else {
      for (let i = pricesAll.length - 1; i >= 0; i--) {
        if (pricesAll[i].date <= dateStr) return pricesAll[i].date;
      }
      return null;
    }
  }

  async function fetchHistory(ticker, start, end) {
    const url = `/api/schdHistory?ticker=${encodeURIComponent(ticker)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error("Failed to fetch price/dividend data: " + (await r.text()));
    return r.json();
  }

  function buildContributionSet(prices, freq, startDateStr) {
    const isContribution = new Set();

    if (freq === "daily") {
      for (const p of prices) isContribution.add(p.date);
      return isContribution;
    }

    // monthly: first trading day in each month (after start)
    let lastMonth = null;
    for (const p of prices) {
      const mk = monthKey(p.date);
      if (mk !== lastMonth) {
        lastMonth = mk;
        if (p.date >= startDateStr) isContribution.add(p.date);
      }
    }
    return isContribution;
  }

  function updateChart(labels, principal, capGain, divNet, total) {
    const ctx = document.getElementById('unifiedChart').getContext('2d');
    if (unifiedChart) unifiedChart.destroy();

    unifiedChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Principal', data: principal, stack: 'a', fill: true, pointRadius: 0 },
          { label: 'Capital Gain', data: capGain, stack: 'a', fill: true, pointRadius: 0 },
          { label: 'Dividends (Net)', data: divNet, stack: 'a', fill: true, pointRadius: 0 },
          { label: 'Total Value', data: total, borderWidth: 2, fill: false, pointRadius: 0 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            stacked: true,
            ticks: { callback: v => "$" + Math.round(v / 1000) + "k" }
          }
        }
      }
    });
  }

  // ‚úÖ allocate quarterly dividends into 3 months (boundary-adjusted)
  function buildMonthlyDivAllocatedUSD(months) {
    const n = months.length;
    const alloc = new Array(n).fill(0);

    for (let i = 0; i < n; i++) {
      const q = months[i].monthDivNetUSD || 0;
      if (q <= 0) continue;

      // default: current month + previous 2 months
      const candidate = [i, i - 1, i - 2];
      let picked = candidate.filter(idx => idx >= 0 && idx < n);

      // if missing (early boundary), push forward to fill 3 months
      let next = i + 1;
      while (picked.length < 3 && next < n) {
        if (!picked.includes(next)) picked.push(next);
        next++;
      }

      const k = picked.length;
      if (k === 0) continue;

      const part = q / k;
      for (const idx of picked) alloc[idx] += part;
    }

    return alloc;
  }

  async function runBacktest() {
    const ticker = document.getElementById('ticker').value.trim() || "SCHD";

    let startInput = document.getElementById('startDate').value;
    let endInput = document.getElementById('endDate').value;

    if (!startInput) { alert("Pick a start date!"); return; }
    if (!endInput) { alert("Pick an end date!"); return; }
    if (endInput < startInput) { alert("End date must be after start date."); return; }

    const freq = document.getElementById('freq').value;
    const buyUSD = Math.max(0, toNum(document.getElementById('buyUSD').value));
    const taxRate = Math.max(0, toNum(document.getElementById('tax').value) / 100);
    const drip = document.getElementById('drip').checked;

    // 1) fetch history
    const data = await fetchHistory(ticker, startInput, endInput);
    const pricesAll = data.prices || [];
    const divsAll = data.dividends || [];

    if (pricesAll.length < 10) {
      alert("Not enough price data. Check ticker / date range.");
      return;
    }

    // 2) clamp by data range, then adjust to nearest trading days
    const firstAvailable = data.firstDate || pricesAll[0].date;
    const lastAvailable = data.lastDate || pricesAll[pricesAll.length - 1].date;

    if (startInput < firstAvailable) startInput = firstAvailable;
    if (endInput > lastAvailable) endInput = lastAvailable;

    const startAdj = clampToNearestTradingDay(pricesAll, startInput, "next");
    const endAdj = clampToNearestTradingDay(pricesAll, endInput, "prev");

    if (!startAdj || !endAdj) {
      alert("Failed to adjust to trading days. Try different dates.");
      return;
    }

    if (startAdj !== startInput) alert(`Start date ${startInput} is not a trading day.\nAdjusted to ${startAdj}.`);
    if (endAdj !== endInput) alert(`End date ${endInput} is not a trading day.\nAdjusted to ${endAdj}.`);

    const startDate = startAdj;
    const endDate = endAdj;

    document.getElementById('startDate').value = startDate;
    document.getElementById('endDate').value = endDate;

    if (endDate < startDate) {
      alert("After adjustment, end date became earlier than start date.");
      return;
    }

    const prices = pricesAll.filter(p => p.date >= startDate && p.date <= endDate);

    // 3) dividend map (date -> perShare)
    const divMap = new Map();
    for (const d of divsAll) {
      if (!d?.date) continue;
      const amt = toNum(d.amount);
      if (amt <= 0) continue;
      divMap.set(d.date, (divMap.get(d.date) || 0) + amt);
    }

    // 4) contribution days
    const contributeSet = buildContributionSet(prices, freq, startDate);

    // 5) simulate (USD)
    let shares = 0;
    let principalUSD = 0;
    let divNetUSD = 0;
    let cashUSD = 0;

    const months = [];
    let currentMonth = null;
    let monthDivNetUSD = 0;

    for (let i = 0; i < prices.length; i++) {
      const { date, close } = prices[i];
      const mk = monthKey(date);

      if (currentMonth === null) {
        currentMonth = mk;
      } else if (mk !== currentMonth) {
        const prev = prices[i - 1];
        const valueUSD = shares * prev.close + cashUSD;
        const capGainUSD = valueUSD - principalUSD - divNetUSD;

        months.push({
          key: currentMonth,
          endDate: prev.date,
          principalUSD,
          divNetUSD,
          capGainUSD,
          valueUSD,
          monthDivNetUSD, // actual (quarterly) payout in that month (net)
          shares,
        });

        currentMonth = mk;
        monthDivNetUSD = 0;
      }

      // (A) buy
      if (contributeSet.has(date)) {
        shares += (buyUSD / close);
        principalUSD += buyUSD;
      }

      // (B) dividend event
      const perShare = divMap.get(date) || 0;
      if (perShare > 0) {
        const gross = shares * perShare;
        const net = gross * (1 - taxRate);
        divNetUSD += net;
        monthDivNetUSD += net;

        if (drip) shares += (net / close);
        else cashUSD += net;
      }
    }

    // last month snapshot
    const last = prices[prices.length - 1];
    const lastValueUSD = shares * last.close + cashUSD;
    const lastCapGainUSD = lastValueUSD - principalUSD - divNetUSD;

    months.push({
      key: currentMonth,
      endDate: last.date,
      principalUSD,
      divNetUSD,
      capGainUSD: lastCapGainUSD,
      valueUSD: lastValueUSD,
      monthDivNetUSD,
      shares,
    });

    // ‚úÖ allocate monthly dividend from quarterly payouts
    const monthlyAllocUSD = buildMonthlyDivAllocatedUSD(months);

    // summary cards
    const finalMonthlyDivUSD = monthlyAllocUSD[months.length - 1] || 0;

    document.getElementById("resTotal").innerText = fmtUSD(lastValueUSD);
    document.getElementById("resProfit").innerText = fmtUSD(lastValueUSD - principalUSD);
    document.getElementById("resMonthlyDiv").innerText = fmtUSD(finalMonthlyDivUSD);

    document.getElementById("dataNotice").innerText =
      `Price data: ${data.firstDate || "-"} ~ ${data.lastDate || "-"} / Backtest: ${startDate} ~ ${endDate}`;

    // build table/chart
    const labels = ["Start"];
    const pData = [0];
    const gData = [0];
    const dData = [0];
    const tData = [0];

    const tableBody = document.getElementById("tableBody");
    tableBody.innerHTML = "";

    // group by year
    const byYear = new Map();
    for (let i = 0; i < months.length; i++) {
      const m = months[i];
      const year = m.key.slice(0,4);
      if (!byYear.has(year)) byYear.set(year, []);
      byYear.get(year).push({ ...m, idx: i });
    }

    const years = Array.from(byYear.keys()).sort();
    for (const y of years) {
      const list = byYear.get(y);

      const yLast = list[list.length - 1];
      const yPrincipal = yLast.principalUSD;
      const yDiv = yLast.divNetUSD;
      const yCapGain = yLast.capGainUSD;
      const yValue = yLast.valueUSD;

      const yearKey = `y${y}`;

      tableBody.innerHTML += `
        <tr class="year-header border-b hover:bg-blue-50 cursor-pointer" onclick="toggleMonths('${yearKey}')">
          <td class="p-3 font-bold text-blue-700">‚ñ∂ ${y}</td>
          <td class="p-3">${fmtUSD(yPrincipal)}</td>
          <td class="p-3 text-emerald-600 font-semibold">${fmtUSD(yCapGain)}</td>
          <td class="p-3 text-amber-600 font-semibold">${fmtUSD(yDiv)}</td>
          <td class="p-3 font-black text-slate-900 bg-slate-50">${fmtUSD(yValue)}</td>
          <td class="p-3 font-bold text-gray-700">-</td>
          <td class="p-3 font-bold text-gray-700">-</td>
        </tr>
      `;

      for (const mm of list) {
        const principal = mm.principalUSD;
        const div = mm.divNetUSD;
        const capGain = mm.capGainUSD;
        const value = mm.valueUSD;

        const quarterDiv = mm.monthDivNetUSD || 0;
        const monthlyDiv = monthlyAllocUSD[mm.idx] || 0;

        labels.push(mm.key);
        pData.push(principal);
        gData.push(capGain);
        dData.push(div);
        tData.push(value);

        const quarterDivText = (quarterDiv > 0) ? fmtUSD(quarterDiv) : "-";

        tableBody.innerHTML += `
          <tr class="month-row month-${yearKey} bg-gray-50 border-b text-gray-500 text-xs">
            <td class="p-2 pl-8 font-medium text-blue-400">„Ñ¥ ${mm.key}</td>
            <td class="p-2">${fmtUSD(principal)}</td>
            <td class="p-2">${fmtUSD(capGain)}</td>
            <td class="p-2">${fmtUSD(div)}</td>
            <td class="p-2 font-bold">${fmtUSD(value)}</td>
            <td class="p-2 text-amber-500">${fmtUSD(monthlyDiv)}</td>
            <td class="p-2 text-amber-500">${quarterDivText}</td>
          </tr>
        `;
      }
    }

    updateChart(labels, pData, gData, dData, tData);
  }

  // defaults
  (async function initDefaults() {
    document.getElementById("endDate").value = ymd(Date.now());

    try {
      const ticker = "SCHD";
      const end = ymd(Date.now());
      const data = await fetchHistory(ticker, "2011-01-01", end);
      const pricesAll = data.prices || [];
      const first = data.firstDate || (pricesAll[0]?.date);
      if (first) {
        document.getElementById("startDate").value = first;
        document.getElementById("dataNotice").innerText =
          `Default start (first trading day): ${first} / Default end: ${end}`;
      } else {
        document.getElementById("startDate").value = "2012-01-03";
      }
    } catch (e) {
      document.getElementById("startDate").value = "2012-01-03";
    }
  })();
</script>
</body>
</html>

